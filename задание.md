# Задание

**Дисциплина:** Язык Java  
**Тема:** Локальная разработка  
**Форма проверки:** Самопроверка. Студент выполняет задание и самостоятельно проверяет его

**Имя преподавателя:** Артур Домбровский  
**Время выполнения:** 4 часа

## Цель задания

Научиться:

- применять методы локальной разработки и контейнеризации Java-приложений с использованием Docker и Docker Compose,
- создавать многостадийные Dockerfile,
- настраивать взаимодействие между приложением и базой данных,
- работать с переменными окружения в Spring Boot.

## Инструменты для выполнения ДЗ

Java 17+, Spring Boot, Docker, Docker Compose, Gradle или Maven, IntelliJ IDEA, GitHub или другой подобный веб-сервис для хостинга IT-проектов и их совместной разработки

## Правила приема работы

Прикрепите ссылку на выполненное задание в GitHub. По ссылке должны быть доступны файлы исходного кода приложения.

## Критерии оценки

**Задание считается выполненным, если:**

- прикреплена ссылка на репозиторий в GitHub с выполненным заданием, соответствующим правилам приёма работы;
- доступ к репозиторию открыт;
- код программы написан на Java и соответствует всем требованиям задания;
- программа компилируется и запускается.

**Задание не выполнено, если:**

- ссылка на репозиторий с заданием не прикреплена или отсутствует доступ по ссылке;
- репозиторий с заданием пуст или содержит материалы, не соответствующие правилам приёма работы и требованиям задания;
- программа не компилируется или не запускается.

**Дедлайн:** Срок сдачи — 7 дней после даты соответствующего вебинара

---

## Задача 1

Создайте минимальный эффективный Dockerfile для приложения.

1. В корне проекта создайте файл `Dockerfile`.
2. Создайте образ с помощью многостадийной сборки:
   - **стадия 1 (build):** используйте образ на основе OpenJDK (например, `gradle:jdk17` или `maven:jdk17`) для компиляции и сборки JAR-файла с помощью `./gradlew build`;
   - **стадия 2 (run):** используйте минимальный базовый образ (например, `openjdk:17-jre-slim`) для запуска приложения, скопируйте только собранный JAR-файл из первой стадии.
3. Установите точку входа (`ENTRYPOINT`) для запуска JAR-файла.

## Задача 2

Объедините приложение и базу данных в одно окружение с помощью Docker Compose.

1. Создайте файл `docker-compose.yml` для определения двух сервисов:
   - **db сервис** — используйте официальный образ PostgreSQL (или MySQL). Установите переменные окружения для базы данных (`POSTGRES_USER`, `POSTGRES_PASSWORD`, `POSTGRES_DB`).
   - **app сервис** — соберите образ из созданного вами Dockerfile (`build: .`).
2. Настройте зависимость (`depends_on`) сервиса `app` от сервиса `db`.
3. Используйте имя сервиса `db` в файле конфигурации Spring Boot (`application.properties`) в качестве хоста подключения к базе данных.
4. Прокиньте порты приложения для доступа к REST API снаружи контейнера.

## Задача 3

Переведите Spring Boot на использование переменных окружения.

1. В Spring Boot приложении измените `application.properties`, чтобы получать критически важные настройки подключения к базе данных из переменных окружения.

**Пример:**

```properties
spring.datasource.url=jdbc:postgresql://${DB_HOST}:5432/${DB_NAME}
spring.datasource.username=${DB_USER}
spring.datasource.password=${DB_PASSWORD}
```

2. Передайте эти переменные окружения в сервис app в файле `docker-compose.yml`, используя блок `environment` и ссылаясь на переменные, заданные в сервисе db.

## Задача 4

Проведите проверку логов и верификацию API.

1. **Сборка и запуск.** Выполните команду:

   **Bash**
   ```bash
   docker compose up --build -d
   ```

2. Проверьте логи сервиса app, чтобы убедиться, что Spring Boot успешно подключился к базе данных (db сервис).

   **Bash**
   ```bash
   docker compose logs app
   ```

3. Проверьте доступность API через пробрашенный порт.

   **Bash**
   ```bash
   curl http://localhost:8080/api/messages
   ```

---

## Чек-лист самопроверки

| Критерии выполнения задания | Отметка о выполнении |
|------------------------------|----------------------|
| • В корне проекта создан файл Dockerfile с многостадийной сборкой<br>• Установлена точка входа для запуска JAR-файла | |
| • В проекте есть файл docker-compose.yml с сервисами app и db, где app зависит от db | |
| • В application.properties настроено использование переменных окружения для подключения к базе данных | |
| • В docker-compose.yml переменные окружения из сервиса db передаются в сервис app | |
| • Приложение корректно запускается с помощью команды docker compose up --build -d<br>• Логи показывают успешное подключение к базе данных<br>• API доступно через внешний порт | |
